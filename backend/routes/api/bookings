const express = require('express')

const {check} = require('express-validator')
const {handleValidationErrors } = require('../../utils/validation.js');
const {requireAuth, restoreUser} = require('../../utils/auth.js');
const {User, Spot, SpotImage, Review, ReviewImage, Booking, Sequelize} = require("../../db/models");

const router = express.Router();

//get all current user's bookings
router.get('/current', requireAuth, async(req, res, next) => {
    const {user} = req;

    const book = await Booking.findAll({
        where: {userId: user.id},
        include:[
            {
                model: Spot,
                attributes: ['id', 'ownerId', 'city', 'state', 'country', 'lat', 'lng', 'name', 'price', 'previewImage']
            }
        ]
    })

})


//edit a booking with bookingId
router.put('/:bookingId', requireAuth, async(req, res, next) => {
    const {bookingId} = req.params;
    const {user} = req;
    const {startDate, endDate} = req.body

    const booking = Booking.findByPk(bookingId)
    userId = parseInt(user.id)
    currBookId = parseInt(booking.userId)

    if(booking && currBookId === userId) {
        const startDay = new Date(startDate)
        const endDay = new Date(endDate)
    
        if(startDay > endDay) {
            const err = new Error(`Validation error`)
            err.status = 400;
            err.errors = {endDate: "endDate cannot be on or before startDate"};
            return next(err)
        }
        if(!booking) {
            const err = new Error(`Booking couldn't be found`)
            err.status = 404;
            return next(err)
        }
        if(new Date() > endDay) {
            const err = new Error(`Past bookings can't be modified`)
            err.status = 403;
            return next(err)
        }
        const alrBooked = await Booking.findOne({
            where : {
                [Op.between]: {startDay, endDay}
            }
        })
        if(alrBooked) {
            const err = new Error(`Sorry, this spot is already booked for the specified dates`)
            err.status = 403;
            err.errors = {
                startDate: "Start date conflicts with an existing booking",
                endDate: "End date conflicts with an existing booking"
            }
            return next(err)
        }
    }

    const newBook = await booking.update({
            startDate,
            endDate
        })
        return res.json(newBook)
})

router.delete('/:bookingId', requireAuth, async(req, res, next) => {
    const {bookingId} = req.params
    const {user} = req;

    const booking = await Booking.findByPk(bookingId)
    userId = user.id
    bookingUserId = parseInt(booking.userId)

    if(booking && bookingUserId === userId) {
        await booking.delete();
        res.json({"message": "Successfully deleted", "statusCode": 200})
    } 
    if(!booking) {
        const err = new Error(`Booking couldn't be found`)
        err.status = 404;
        return next(error)
    }
    if(booking.startDate < new Date()) {
        const err = new Error(`Bookings that have been started can't be deleted`)
        err.status = 403;
        return next(error)
    }
})

module.exports = router